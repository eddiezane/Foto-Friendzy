<!DOCTYPE html>
<html>
  <head>
    <title>New Game</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script src="/socket.io/socket.io.js"></script>
    <script src="/javascripts/megapix.js"></script>
    <script src="/javascripts/canvas-toBlob.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script>
      var socket = io.connect('/');
      var herp;

      $(document).ready(function() {
          socket.emit('join'); 

          // Receive db from server. Listen for dropdown change
          socket.on('reply', function(db) {
            var dropdown = $('#dropdown');
            for (var index in db.locations) {
              var place = db.locations[index].name;
              var opt = document.createElement('option');
              opt.setAttribute('value', place);
              opt.text = place;
              dropdown.append(opt);
            }
            dropdown.show();
            dropdown.change(function() {
              var val = $('#dropdown').val();
              if (val != 'null') {
                socket.emit('location', val);
              }
            });
          });

          $('#image').on('change', function(e) {
            var file = document.querySelector('input[type=file]').files[0];
            drawImage(file);
            // Terrible hack to wait for canvas to draw since images load asyc.
            setTimeout(function() {
              $('#canvas')[0].toBlob(function(blob) {
                console.log(blob);
                socket.emit('data', blob);
              });
            }, 300);
          });

          socket.on('image', function(data) {
            drawImage(new Blob([data], {type:'image/png'}));
          });
      });

      function drawImage(file) {
        var img = new MegaPixImage(file);
        var canvas = $('#canvas')[0];
        img.render(canvas, {maxWidth: 600, maxHeight: 600, orientation: 6});
      }
    </script>
  </head>
  <body>
    <div id='location'>
      <select id='dropdown' style='display:none;'>
        <option value='null'>Choose a location</option>
      </select>
    </div>
    <form id='form' action=''>
      <input type="file" name="image" id="image" accept="image/*;capture=camera">
    </form>
    <canvas id="canvas" height="400" width="400">
    </canvas>
  </body>
</html>
